<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMboxè¯†åˆ«åˆ†å‘ä¸­å¿ƒ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --error: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        h2 { color: var(--primary); margin-bottom: 1.5rem; }
        
        /* çŠ¶æ€æç¤ºæ¡† */
        .status-box { padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 0.95rem; font-weight: bold; border: 1px solid transparent; transition: 0.3s; }
        .status-loading { background: #f8f9fa; color: #666; border-color: #ddd; }
        .status-open { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-closed { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-wait { background: #fff3cd; color: #856404; border-color: #ffeeba; }

        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--accent); outline: none; }
        
        button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #2980b9; }
        
        .hidden { display: none !important; }
        
        .result-area { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; animation: fadeIn 0.5s; }
        .download-btn { display: block; padding: 12px; margin-top: 10px; text-decoration: none; border-radius: 6px; background: #f8f9fa; border: 1px solid #ddd; color: #333; font-weight: bold; transition: 0.2s; }
        .download-btn:hover { background: #e2e6ea; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .download-btn.key { border-left: 5px solid #f1c40f; }
        .download-btn.prog { border-left: 5px solid #3498db; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .footer { margin-top: 20px; font-size: 12px; color: #999; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>

<div class="card">
    <h2>CVè¯†åˆ«ä¸‹è½½ä¸­å¿ƒ</h2>
    
    <div id="statusBox" class="status-box status-loading">æ­£åœ¨è¿æ¥æœåŠ¡å™¨è§„åˆ™...</div>
    
    <div id="timeMsg" style="margin-bottom: 15px; color: #666; font-size: 0.85rem;"></div>

    <div id="inputArea" class="hidden">
        <input type="text" id="orderId" placeholder="è¯·è¾“å…¥æ‚¨çš„éªŒè¯ç  (Order ID)">
        <button id="btnVerify" onclick="checkAndDownload()">æŸ¥è¯¢å¹¶è·å–æ–‡ä»¶</button>
    </div>

    <div id="resultArea" class="hidden result-area">
        <p style="color:var(--success); font-weight:bold; margin-bottom: 15px;">âœ… éªŒè¯é€šè¿‡</p>
        <a id="linkProg" class="download-btn prog" href="#" target="_blank">ğŸ“¦ ä¸‹è½½ä¸»ç¨‹åº (Program)</a>
        <a id="linkKey" class="download-btn key" href="#" target="_blank">ğŸ”‘ ä¸‹è½½æœ€æ–°å¯†é’¥ (License)</a>
        <div style="margin-top:10px; font-size:12px; color:#888;">æ³¨æ„ï¼šä¸‹è½½åè¯·è§£å‹ä½¿ç”¨</div>
    </div>

    <div class="footer">Powered by EIVEN Secure System</div>
</div>

<script>
    // =======================================================
    // [é…ç½®] å¿…é¡»ä¸ Builder.py ä¸­çš„ LICENSE_SEED ä¿æŒå®Œå…¨ä¸€è‡´
    const SEED = "EIVEN_SECURE_2026_SYSTEM_SALT_X9"; 
    // =======================================================

    const statusBox = document.getElementById('statusBox');
    const inputArea = document.getElementById('inputArea');
    const timeMsg = document.getElementById('timeMsg');
    const resultArea = document.getElementById('resultArea');

    // é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œâ€œæŸ¥å²—â€ä»»åŠ¡
    window.onload = function() {
        checkServerRules();
    };

    function checkServerRules() {
        // æ·»åŠ æ—¶é—´æˆ³ t=... é˜²æ­¢æµè§ˆå™¨ç¼“å­˜æ—§çš„è§„åˆ™æ–‡ä»¶
        fetch('server_status.json?t=' + new Date().getTime())
            .then(response => {
                if (!response.ok) throw new Error("è§„åˆ™æ–‡ä»¶ä¸¢å¤±");
                return response.json();
            })
            .then(config => {
                applyRules(config);
            })
            .catch(err => {
                console.error(err);
                // å¦‚æœæ‰¾ä¸åˆ°è§„åˆ™æ–‡ä»¶ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œé»˜è®¤é”æ­»
                lockDown("status-closed", "âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨è§„åˆ™åº“ (404)", "è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æ¨é€çŠ¶æ€");
            });
    }

    function applyRules(config) {
        // 1. æ£€æŸ¥æ€»å¼€å…³ (Builderä¸­çš„â€œå¼€å¯å¼€æ”¾æ—¶é—´çª—å£â€)
        if (config.access_enabled === false) {
            lockDown("status-closed", "ğŸš« é€šé“å·²å…³é—­", "å½“å‰ä¸åœ¨å¼€æ”¾ä¸‹è½½æ—¶æ®µï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜é€šçŸ¥");
            return;
        }

        // 2. æ£€æŸ¥æ—¶é—´çª—å£
        // å…¼å®¹ iOS/Safari çš„æ—¥æœŸæ ¼å¼ (å°†ç©ºæ ¼æ¢æˆ T æˆ–ç›´æ¥è§£æ)
        // Builder ç”Ÿæˆæ ¼å¼: "2023-10-27 12:00:00" -> JS Date å¯èƒ½éœ€è¦ "2023/10/27..."
        const now = new Date();
        const start = new Date(config.valid_from.replace(/-/g, "/")); 
        const end = new Date(config.valid_until.replace(/-/g, "/"));

        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            // å¦‚æœæ—¶é—´è§£æå¤±è´¥ï¼Œå¼€æ”¾è®¿é—®ä½†æç¤ºè­¦å‘Š
            unlock("âœ… é€šé“å¼€æ”¾ä¸­ (æ—¶é—´æ ¼å¼å¿½ç•¥)");
            return;
        }

        if (now < start) {
            lockDown("status-wait", "â³ å°šæœªå¼€æ”¾", `å¼€æ”¾æ—¶é—´: ${config.valid_from}`);
        } else if (now > end) {
            lockDown("status-closed", "â›” å¼€æ”¾æ—¶é—´å·²è¿‡", `æˆªæ­¢æ—¶é—´: ${config.valid_until}`);
        } else {
            // 3. ä¸€åˆ‡æ­£å¸¸ï¼Œè§£é”ç•Œé¢
            unlock(`è¯·åœ¨ ${config.valid_until} å‰å®Œæˆä¸‹è½½`);
        }
    }

    // é”å®šç•Œé¢ï¼šæ˜¾ç¤ºçº¢/é»„æ¡†ï¼Œéšè—è¾“å…¥æ¡†
    function lockDown(cssClass, mainText, subText) {
        statusBox.className = "status-box " + cssClass;
        statusBox.textContent = mainText;
        timeMsg.innerText = subText || "";
        inputArea.classList.add('hidden'); // ç‰©ç†éšè—è¾“å…¥æ¡†
        resultArea.classList.add('hidden');
    }

    // è§£é”ç•Œé¢ï¼šæ˜¾ç¤ºç»¿æ¡†ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
    function unlock(subText) {
        statusBox.className = "status-box status-open";
        statusBox.textContent = "âœ… é€šé“å¼€æ”¾ä¸­";
        timeMsg.innerText = subText || "";
        inputArea.classList.remove('hidden'); // æ˜¾ç¤ºè¾“å…¥æ¡†
    }

    // æ ¸å¿ƒé€»è¾‘ï¼šéªŒè¯ ID å¹¶è®¡ç®—ä¸‹è½½é“¾æ¥
    function checkAndDownload() {
        const oid = document.getElementById('orderId').value.trim();
        const btnVerify = document.getElementById('btnVerify');

        if (!oid) { alert("è¯·è¾“å…¥éªŒè¯ç "); return; }

        btnVerify.disabled = true;
        btnVerify.textContent = "æ­£åœ¨æ ¡éªŒ...";

        try {
            // 1. è®¡ç®—å“ˆå¸Œ (SHA256) - å¿…é¡»ä¸ Python ç®—æ³•ä¸€è‡´
            const rawHash = CryptoJS.SHA256(oid + SEED).toString(CryptoJS.enc.Hex);
            const hashId = rawHash.substring(0, 16).toLowerCase();

            // 2. æ„é€ æ–‡ä»¶è·¯å¾„
            // GitHub Pages è·¯å¾„ç»“æ„: ./releases/{hashId}/EIVEN_Program.zip
            const progUrl = `./releases/${hashId}/EIVEN_Program.zip`;
            const keyUrl = `./releases/${hashId}/EIVEN_License.zip`;

            // 3. æ¢æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (ä½¿ç”¨ HEAD è¯·æ±‚)
            // è¿™ä¸€æ­¥æ˜¯ä¸ºäº†éªŒè¯ç”¨æˆ·è¾“å…¥çš„ ID æ˜¯å¦çœŸå®å­˜åœ¨äºæœåŠ¡å™¨ä¸Š
            // 3. æ¢æµ‹æ–‡ä»¶ (å¢åŠ  ?t=... é˜²æ­¢æµè§ˆå™¨ç¼“å­˜ 404 çŠ¶æ€)
            const checkUrl = `${progUrl}?t=${new Date().getTime()}`;
            fetch(checkUrl, { method: 'HEAD' })
                .then(res => {
                .then(res => {
                    if (res.ok) {
                        // å­˜åœ¨ -> æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        document.getElementById('linkProg').href = progUrl;
                        document.getElementById('linkKey').href = keyUrl;
                        
                        inputArea.classList.add('hidden'); // éšè—è¾“å…¥æ¡†é˜²æ­¢é‡å¤æäº¤
                        statusBox.textContent = "ğŸ‰ éªŒè¯æˆåŠŸ";
                        resultArea.classList.remove('hidden');
                    } else {
                        throw new Error("404 Not Found");
                    }
                })
                .catch(err => {
                    alert("âŒ éªŒè¯å¤±è´¥ï¼šæœªæ‰¾åˆ°è¯¥è®¢å•æ–‡ä»¶ã€‚\nè¯·æ£€æŸ¥éªŒè¯ç æ˜¯å¦è¾“å…¥æ­£ç¡®ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
                    btnVerify.disabled = false;
                    btnVerify.textContent = "æŸ¥è¯¢å¹¶è·å–æ–‡ä»¶";
                });

        } catch (e) {
            alert("ç³»ç»Ÿé”™è¯¯: " + e.message);
            btnVerify.disabled = false;
        }
    }
</script>

</body>
</html>